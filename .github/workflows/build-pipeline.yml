name: Build Pipeline

on:
  workflow_call:
    outputs:
      scheduler-engine-changed:
        value: ${{ jobs.check-changes.outputs.scheduler-engine-changed }}
      api-changed:
        value: ${{ jobs.check-changes.outputs.api-changed }}
      sim-feed-app-changed:
        value: ${{ jobs.check-changes.outputs.sim-feed-app-changed }}
      user-service-changed:
        value: ${{ jobs.check-changes.outputs.user-service-changed }}

  push:
    branches:
      - '**'
      - '!prod'

  pull_request:
    branches:
      - main
      - prod

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      scheduler-engine-changed: ${{ steps.filter.outputs.scheduler-engine }}
      api-changed: ${{ steps.filter.outputs.api }}
      sim-feed-app-changed: ${{ steps.filter.outputs.sim-feed-app }}
      user-service-changed: ${{ steps.filter.outputs.user-service-changed }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: main
          filters: |
            scheduler-engine:
              - 'scheduler-engine/**'
            api:
              - 'api/**'
            sim-feed-app:
              - 'sim-feed-app/**'
            user-service:
              - 'user-service/**'

  build-scheduler-engine:
    name: Build Scheduler Engine
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.scheduler-engine-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: chmod +x ./bin/build_scheduler.sh
      - run: ./bin/build_scheduler.sh

  unit-tests-scheduler-engine:
    name: Unit Tests â€“ Scheduler Engine
    runs-on: ubuntu-latest
    needs: build-scheduler-engine
    if: needs.build-scheduler-engine.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - run: chmod +x ./bin/test_scheduler.sh
      - run: ./bin/test_scheduler.sh

  build-api-handlers:
    name: Build API Handlers
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.api-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.26.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: ./api/pnpm-lock.yaml
      - run: pnpm install
        working-directory: ./api
      - run: pnpm build
        working-directory: ./api

  unit-tests-api-handlers:
    name: Unit Tests â€“ API
    runs-on: ubuntu-latest
    needs: build-api-handlers
    if: needs.build-api-handlers.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.26.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: ./api/pnpm-lock.yaml
      - run: pnpm install
        working-directory: ./api
      - run: pnpm test
        working-directory: ./api

  build-sim-feed-app:
    name: Build Sim Feed App
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.sim-feed-app-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: ./sim-feed-app/pnpm-lock.yaml
      - run: pnpm install
        working-directory: ./sim-feed-app
      - run: pnpm build
        working-directory: ./sim-feed-app

  unit-tests-sim-feed-app:
    name: Unit Tests â€“ Sim Feed App
    runs-on: ubuntu-latest
    needs: build-sim-feed-app
    env:
      VITE_USER_API_URL: http://fake-url.com
    if: needs.build-sim-feed-app.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: ./sim-feed-app/pnpm-lock.yaml
      - run: pnpm install
        working-directory: ./sim-feed-app
      - run: pnpm test:run
        working-directory: ./sim-feed-app
        
  build-user-service:
    name: Build User Service
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.user-service-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: chmod +x ./bin/build_user_service.sh
      - run: ./bin/build_user_service.sh
  
  unit-tests-user-service:
    name: Unit Tests - User Service
    runs-on: ubuntu-latest
    needs: build-user-service
    if: needs.build-user-service.result == 'success'
    env:
      SPRING_PROFILES_ACTIVE: test
    steps:
          - uses: actions/checkout@v4
          - name: Set up JDK 21
            uses: actions/setup-java@v4
            with:
              java-version: '21'
              distribution: 'temurin'
          - name: Cache Maven packages
            uses: actions/cache@v3
            with:
              path: ~/.m2/repository
              key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
              restore-keys: |
                ${{ runner.os }}-maven-
          - name: Run tests
            run: mvn clean test
            working-directory: ./user-service
    
        
  integration-tests:
    name: Integration Tests (PR Only)
    runs-on: ubuntu-latest
    needs:
      - unit-tests-scheduler-engine
      - unit-tests-api-handlers
      - unit-tests-sim-feed-app
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Run Integration Tests
        working-directory: ./tests/integration-tests
        run: |
          docker compose up --build -d
          docker compose logs -f test-runner &
          docker compose wait test-runner
          exit_code=$(docker compose ps -a --format json \
            | jq -r 'select(.Name == "integration-test-runner") | .ExitCode')
          docker compose down -v
          exit $exit_code

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Write summary
        run: |
          {
            echo "## ðŸš€ Build Summary"
            echo ""
            echo "- Trigger: \`${{ github.event_name }}\`"
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"