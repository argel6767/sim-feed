name: Build Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - prod

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      scheduler-engine-changed: ${{ steps.filter.outputs.scheduler-engine }}
      api-changed: ${{ steps.filter.outputs.api }}
      sim-feed-app-changed: ${{ steps.filter.outputs.sim-feed-app }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: main
          filters: |
            scheduler-engine:
              - 'scheduler-engine/**'
            api:
              - 'api/**'
            sim-feed-app:
              - 'sim-feed-app/**'

  build-scheduler-engine:
    name: Build Scheduler Engine
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.scheduler-engine-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Make Build Script Executable
        run: chmod +x ./bin/build_scheduler.sh
      - name: Run Build Script
        run: ./bin/build_scheduler.sh

  unit-tests-scheduler-engine:
    name: Run Unit Tests for Scheduler Engine
    runs-on: ubuntu-latest
    needs: build-scheduler-engine
    if: needs.build-scheduler-engine.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Make Test Script Executable
        run: chmod +x ./bin/test_scheduler.sh
      - name: Run Test Script
        run: ./bin/test_scheduler.sh

  build-api-handlers:
    name: Build API Handlers
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.api-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.26.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "./api/pnpm-lock.yaml"
      - run: pnpm install
        working-directory: ./api
      - run: pnpm build
        working-directory: ./api

  unit-tests-api-handlers:
    name: Run Unit Tests for API Handlers
    runs-on: ubuntu-latest
    needs: build-api-handlers
    if: needs.build-api-handlers.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "./api/pnpm-lock.yaml"
      - run: pnpm install
        working-directory: ./api
      - run: pnpm test
        working-directory: ./api

  build-sim-feed-app:
    name: Build Sim Feed App
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.sim-feed-app-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "./sim-feed-app/pnpm-lock.yaml"
      - run: pnpm install
        working-directory: ./sim-feed-app
      - run: pnpm build
        working-directory: ./sim-feed-app

  unit-tests-sim-feed-app:
    name: Run Unit Tests for Sim Feed App
    runs-on: ubuntu-latest
    needs: build-sim-feed-app
    if: needs.build-sim-feed-app.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "./sim-feed-app/pnpm-lock.yaml"
      - run: pnpm install
        working-directory: ./sim-feed-app
      - run: pnpm test:run
        working-directory: ./sim-feed-app

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - check-changes
      - build-scheduler-engine
      - unit-tests-scheduler-engine
      - build-api-handlers
      - unit-tests-api-handlers
      - build-sim-feed-app
      - unit-tests-sim-feed-app
    if: always()
    steps:
      - name: Write summary
        run: |
          {
            echo "## ðŸš€ Deployment Summary"
            echo ""
            echo "### ðŸ” Change Detection"
            echo "- Scheduler Engine changed: **${{ needs.check-changes.outputs.scheduler-engine-changed }}**"
            echo "- API changed: **${{ needs.check-changes.outputs.api-changed }}**"
            echo "- Sim Feed App changed: **${{ needs.check-changes.outputs.sim-feed-app-changed }}**"
            echo ""
            echo "### ðŸ—ï¸ Scheduler Engine"
            echo "- Build: **${{ needs.build-scheduler-engine.result || 'skipped' }}**"
            echo "- Tests: **${{ needs.unit-tests-scheduler-engine.result || 'skipped' }}**"
            echo ""
            echo "### ðŸ—ï¸ API Handlers"
            echo "- Build: **${{ needs.build-api-handlers.result || 'skipped' }}**"
            echo "- Tests: **${{ needs.unit-tests-api-handlers.result || 'skipped' }}**"
            echo ""
            echo "### ðŸ—ï¸ Sim Feed App"
            echo "- Build: **${{ needs.build-sim-feed-app.result || 'skipped' }}**"
            echo "- Tests: **${{ needs.unit-tests-sim-feed-app.result || 'skipped' }}**"
            echo ""
            echo ""
            echo "### ðŸ§¾ Metadata"
            echo "- Workflow: \`${{ github.workflow }}\`"
            echo "- Trigger: \`${{ github.event_name }}\`"
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
