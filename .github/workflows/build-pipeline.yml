name: Build Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      scheduler-engine-changed: ${{ steps.filter.outputs.scheduler-engine }}
      api-changed: ${{ steps.filter.outputs.api }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: main
          filters: |
            scheduler-engine:
              - 'scheduler-engine/**'
            api:
              - 'api/**'

  build-scheduler-engine:
    name: Build Scheduler Engine
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.scheduler-engine-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Make Build Script Executable
        run: chmod +x ./bin/build_scheduler.sh
      - name: Run Build Script
        run: ./bin/build_scheduler.sh

  unit-tests-scheduler-engine:
    name: Run Unit Tests for Scheduler Engine
    runs-on: ubuntu-latest
    needs: build-scheduler-engine
    if: needs.build-scheduler-engine.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Make Test Script Executable
        run: chmod +x ./bin/test_scheduler.sh
      - name: Run Test Script
        run: ./bin/test_scheduler.sh
        
  build-api-handlers:
    name: Build API Handlers
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.api-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup-pnpm@v2
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm build
      
  unit-tests-api-handlers:
    name: Run Unit Tests for API Handlers
    runs-on: ubuntu-latest
    needs: build-api-handlers
    if: needs.build-api-handlers.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup-pnpm@v2
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm test
        
  run-all-services:
    name: Run All Services
    runs-on: ubuntu-latest
    needs:
      - check-changes
      - build-scheduler-engine
      - test-scheduler-engine
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Make Run Script Executable
        run: chmod +x ./bin/run_all_services.sh
      - name: Run All Services Script
        run: ./bin/run_all_services.sh
        
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - check-changes
      - build-scheduler-engine
      - unit-tests-scheduler-engine
      - build-api-handlers
      - unit-tests-api-handlers
      - run-all-services
    if: always()
    steps:
      - name: Write summary
        run: |
          {
            echo "## ðŸš€ Deployment Summary"
            echo ""
            echo "### ðŸ” Change Detection"
            echo "- Scheduler Engine changed: **${{ needs.check-changes.outputs.scheduler-engine-changed }}**"
            echo "- API changed: **${{ needs.check-changes.outputs.api-changed }}**"
            echo ""
            echo "### ðŸ—ï¸ Scheduler Engine"
            echo "- Build: **${{ needs.build-scheduler-engine.result || 'skipped' }}**"
            echo "- Tests: **${{ needs.unit-tests-scheduler-engine.result || 'skipped' }}**"
            echo ""
            echo "### ðŸ—ï¸ API Handlers"
            echo "- Build: **${{ needs.build-api-handlers.result || 'skipped' }}**"
            echo "- Tests: **${{ needs.unit-tests-api-handlers.result || 'skipped' }}**"
            echo ""
            echo "### ðŸ—ï¸ All Services"
            echo "- Run: **${{ needs.run-all-services.result || 'skipped' }}**"
            echo ""
            echo "### ðŸ§¾ Metadata"
            echo "- Workflow: \`${{ github.workflow }}\`"
            echo "- Trigger: \`${{ github.event_name }}\`"
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"